{% extends 'base.html' %}
{% load static %}

{% block title %}Корзина{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row">
    <div class="col-lg-8">
      <h2 class="mb-4">
        <i class="fas fa-shopping-cart me-2 text-primary"></i>Корзина
      </h2>
      
      {% if cart_items %}
        <div class="card shadow-sm">
          <div class="card-body">
            {% for item in cart_items %}
            <div class="row align-items-center py-3 border-bottom">
              <div class="col-md-2">
                {% if item.product.image %}
                  <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="img-fluid rounded">
                {% else %}
                  <div class="image-placeholder rounded">
                    <i class="fas fa-image"></i>
                  </div>
                {% endif %}
              </div>
              <div class="col-md-4">
                <h6 class="mb-1">
                  <a href="{% url 'main:product_detail' item.product.id item.product.slug %}" class="text-decoration-none">
                    {{ item.product.name }}
                  </a>
                </h6>
                <p class="text-muted small mb-0">{{ item.product.category.name }}</p>
                <p class="text-success fw-bold mb-0">{{ item.product.price }} ₽</p>
              </div>
              <div class="col-md-3">
                <div class="input-group input-group-sm">
                  <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity({{ item.id }}, -1)">
                    <i class="fas fa-minus"></i>
                  </button>
                  <input type="number" class="form-control text-center" value="{{ item.quantity }}" min="1" max="99" 
                         onchange="updateQuantity({{ item.id }}, this.value - {{ item.quantity }})">
                  <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity({{ item.id }}, 1)">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>
              <div class="col-md-2 text-end">
                <p class="fw-bold mb-0">{{ item.total_price }} ₽</p>
              </div>
              <div class="col-md-1 text-end">
                <button class="btn btn-outline-danger btn-sm" onclick="removeItem({{ item.id }})">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      {% else %}
        <div class="text-center py-5">
          <i class="fas fa-shopping-cart fa-5x text-muted mb-3"></i>
          <h4 class="text-muted">Корзина пуста</h4>
          <p class="text-muted">Добавьте товары в корзину, чтобы продолжить покупки</p>
          <a href="{% url 'main:product_list' %}" class="btn btn-primary">
            <i class="fas fa-shopping-bag me-2"></i>Перейти к товарам
          </a>
        </div>
      {% endif %}
    </div>
    
    {% if cart_items %}
    <div class="col-lg-4">
      <div class="card shadow-sm sticky-top" style="top: 2rem;">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-calculator me-2"></i>Итого
          </h5>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <span>Товары ({{ total_items }}):</span>
            <span>{{ subtotal }} ₽</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Доставка:</span>
            <span class="text-success">Бесплатно</span>
          </div>
          <hr>
          <div class="d-flex justify-content-between mb-3">
            <strong>Итого к оплате:</strong>
            <strong class="text-primary fs-5">{{ total }} ₽</strong>
          </div>
          <button class="btn btn-primary w-100 mb-2" onclick="checkout()">
            <i class="fas fa-credit-card me-2"></i>Оформить заказ
          </button>
          <button class="btn btn-outline-secondary w-100" onclick="clearCart()">
            <i class="fas fa-trash me-2"></i>Очистить корзину
          </button>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
function updateQuantity(itemId, change) {
  const newQuantity = parseInt(document.querySelector(`input[onchange*="${itemId}"]`).value) + change;
  if (newQuantity < 1) return;
  
  fetch(`/cart/update/${itemId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      quantity: newQuantity
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert('Ошибка при обновлении количества');
    }
  });
}

function removeItem(itemId) {
  if (confirm('Вы уверены, что хотите удалить этот товар из корзины?')) {
    fetch(`/cart/remove/${itemId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Ошибка при удалении товара');
      }
    });
  }
}

function clearCart() {
  if (confirm('Вы уверены, что хотите очистить корзину?')) {
    fetch('/cart/clear/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Ошибка при очистке корзины');
      }
    });
  }
}

function checkout() {
  window.location.href = '/cart/checkout/';
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}
