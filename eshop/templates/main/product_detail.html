{% extends "base.html" %}
{% block title %}{{ product.name }}{% endblock %}
{% block content %}
  <div class="container my-5">
    <div class="row">
      <div class="col-md-6">
        {% if product.image %}
          <img src="{{ product.image.url }}"
               class="img-fluid rounded"
               alt="{{ product.name }}" />
        {% else %}
          <div class="image-placeholder rounded"
               style="height: 400px">
            <i class="fas fa-image"></i>
          </div>
        {% endif %}
      </div>
      <div class="col-md-6">
        <h1>{{ product.name }}</h1>
        <p class="text-muted">{{ product.category.name }}</p>
        <h3 class="my-4">{{ product.price }} руб.</h3>
        <p>{{ product.description }}</p>
        <div class="my-4">
          {% if product.available %}
            <span class="badge bg-success">В наличии</span>
          {% else %}
            <span class="badge bg-danger">Нет в наличии</span>
          {% endif %}
        </div>
        <div class="d-flex align-items-center gap-3">
          <div class="input-group" style="max-width: 150px;">
            <button class="btn btn-outline-secondary" type="button" onclick="changeQuantity(-1)">
              <i class="fas fa-minus"></i>
            </button>
            <input type="number" id="quantity" class="form-control text-center" value="1" min="1" max="99">
            <button class="btn btn-outline-secondary" type="button" onclick="changeQuantity(1)">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <button class="btn btn-primary btn-lg" onclick="addToCart()">
            <i class="fas fa-shopping-cart me-2"></i>Добавить в корзину
          </button>
        </div>
        
        <script>
        function changeQuantity(change) {
          const input = document.getElementById('quantity');
          const newValue = parseInt(input.value) + change;
          if (newValue >= 1 && newValue <= 99) {
            input.value = newValue;
          }
        }
        
        function addToCart() {
          const quantity = parseInt(document.getElementById('quantity').value);
          const productId = {{ product.id }};
          
          fetch(`/cart/add/${productId}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              quantity: quantity
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert(data.message);
              // Обновляем счетчик корзины в навигации
              updateCartCounter(data.cart_total);
            } else {
              alert('Ошибка: ' + data.message);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка при добавлении в корзину');
          });
        }
        
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }
        
        function updateCartCounter(total) {
          // Здесь можно обновить счетчик корзины в навигации
          console.log('Корзина обновлена, всего товаров:', total);
        }
        </script>
      </div>
    </div>

    <!-- Рекомендуемые товары -->
    {% if recommended_products %}
      <hr class="my-5" />
      <h2>Рекомендуем также</h2>
      <div class="row">
        {% for product in recommended_products %}
          <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card h-100">
              <a href="{{ product.get_absolute_url }}">
                {% if product.image %}
                  <img class="card-img-top"
                       src="{{ product.image.url }}"
                       alt="{{ product.name }}" />
                {% else %}
                  <div class="card-img-top image-placeholder">
                    <i class="fas fa-image"></i>
                  </div>
                {% endif %}
              </a>
              <div class="card-body">
                <h5 class="card-title">
                  <a href="{{ product.get_absolute_url }}">{{ product.name }}</a>
                </h5>
                <h6>{{ product.price }} руб.</h6>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% endblock %}
